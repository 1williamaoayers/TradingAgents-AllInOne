# 数据源透明度改进方案

## 问题描述

用户在前端输入`01810`，选择LLM，点击"开始分析"后，只能看到最终的分析报告，**看不到后台使用了哪些数据源**。

### 当前状态

1. **日志中有数据源信息**（用户看不到）:
   ```
   [统一新闻工具] ✅ yfinance新闻: 10 条
   [统一新闻工具] 🎉 融合完成: 5个数据源
   ```

2. **中间报告有数据源信息**（用户看不到）:
   ```markdown
   📊 数据来源: 东方财富, Playwright爬虫, 多源快讯, Serper, yfinance (5个)
   ```

3. **最终分析报告无数据源信息**（用户能看到）:
   - `news_report.md` - 只有分析内容，没有数据源说明
   - `investment_plan.md` - 只有投资建议，没有数据源说明

---

## 改进方案

### 方案1: 在最终报告开头添加数据源说明 ⭐ 推荐

#### 实施位置
修改生成最终报告的Agent提示词，要求在报告开头添加数据源信息。

#### 效果示例
```markdown
# 小米集团-W (01810.HK) 新闻与资金面深度分析报告

**报告日期**: 2026年1月23日

---

## 📊 数据来源说明

本报告基于以下**5个数据源**的综合分析：

1. ✅ **东方财富** - 个股实时新闻
2. ✅ **Playwright爬虫** - 网页抓取新闻
3. ✅ **多源快讯** - AKShare多源快讯
4. ✅ **Serper** - Google实时搜索
5. ✅ **yfinance** - Yahoo Finance新闻（10条）

📏 **总数据量**: 15,234 字符  
🔄 **去重统计**: 3条重复已移除

---

## 一、核心新闻事件总结
...
```

#### 实施方法
在Agent的system prompt中添加要求：
```python
system_prompt = """
你是一名专业的财经新闻分析师。

**重要要求**：
1. 在报告开头必须添加"数据来源说明"章节
2. 列出所有使用的数据源名称
3. 标注每个数据源的数据量（如新闻条数）
4. 让用户清楚知道分析基于哪些信息源

报告格式：
# 标题
## 📊 数据来源说明
（列出所有数据源）
## 一、核心分析
（正文内容）
"""
```

---

### 方案2: 在报告末尾添加数据源附录

#### 效果示例
```markdown
...（正文内容）...

---

## 附录：数据来源详情

### 使用的数据源

| 序号 | 数据源 | 数据量 | 状态 |
|------|--------|--------|------|
| 1 | 东方财富 | 8条新闻 | ✅ 成功 |
| 2 | Playwright爬虫 | 5,234字符 | ✅ 成功 |
| 3 | 多源快讯 | 3,456字符 | ✅ 成功 |
| 4 | Serper | 4,567字符 | ✅ 成功 |
| 5 | yfinance | 10条新闻 | ✅ 成功 |

### 数据源说明

- **东方财富**: 提供A股和港股的实时新闻
- **Playwright爬虫**: 自动抓取财经网站新闻
- **多源快讯**: AKShare提供的多源快讯聚合
- **Serper**: Google实时搜索结果
- **yfinance**: Yahoo Finance提供的国际新闻

### 数据质量

- 总数据量: 15,234字符
- 去重后: 14,890字符
- 去重率: 2.3%
```

---

### 方案3: 在前端显示数据源进度

#### 实施位置
修改前端进度显示，实时显示正在使用的数据源。

#### 效果示例
```
分析进度：
✅ 正在获取东方财富新闻... (完成)
✅ 正在获取Playwright爬虫数据... (完成)
✅ 正在获取多源快讯... (完成)
✅ 正在获取Serper搜索结果... (完成)
✅ 正在获取yfinance新闻... (完成，10条)
⏳ 正在生成分析报告...
```

#### 实施方法
使用WebSocket或SSE推送进度信息到前端。

---

### 方案4: 添加数据源使用统计页面

#### 实施位置
在前端添加一个"数据源统计"标签页。

#### 效果示例
```
数据源使用情况

本次分析使用了5个数据源：

[东方财富] ████████░░ 80% (8条新闻)
[Playwright] ██████░░░░ 60% (5,234字符)
[多源快讯] ████████░░ 75% (3,456字符)
[Serper] ██████████ 100% (4,567字符)
[yfinance] ██████████ 100% (10条新闻)

数据源详情：
- 成功: 5个
- 失败: 0个
- 总数据量: 15,234字符
```

---

## 推荐实施顺序

### 第一阶段（立即实施）
✅ **方案1**: 修改Agent提示词，在报告开头添加数据源说明
- 优点: 实施简单，用户立即可见
- 工作量: 小（修改prompt即可）

### 第二阶段（短期优化）
⏳ **方案3**: 前端显示数据源进度
- 优点: 用户体验好，实时反馈
- 工作量: 中（需要前后端配合）

### 第三阶段（长期优化）
⏳ **方案4**: 添加数据源统计页面
- 优点: 数据透明，可追溯
- 工作量: 大（需要新增功能模块）

---

## 具体实施代码

### 修改Agent提示词（方案1）

**文件位置**: 需要找到生成最终报告的Agent配置

**修改内容**:
```python
# 在news_analyst的system prompt中添加
system_prompt = """
你是一名专业的财经新闻分析师。

**报告格式要求**：

1. 报告开头必须包含"数据来源说明"章节
2. 格式如下：

## 📊 数据来源说明

本报告基于以下数据源的综合分析：

{sources_list}

📏 总数据量: {total_chars} 字符
🔄 去重统计: {duplicates} 条重复已移除

---

3. 然后再开始正文分析

**示例**：
## 📊 数据来源说明
本报告基于以下5个数据源：
1. ✅ 东方财富 - 8条新闻
2. ✅ yfinance - 10条新闻
...
"""
```

### 传递数据源信息给Agent

**文件位置**: `unified_news_tool.py`

**修改内容**:
```python
# 在返回结果时添加元数据
def _format_news_result(self, report: str, source_info: str, model_info: str) -> str:
    """格式化新闻结果，添加数据源元数据"""
    
    # 提取数据源信息
    sources_metadata = {
        'sources_used': self.sources_used,  # ['东方财富', 'yfinance', ...]
        'sources_count': len(self.sources_used),
        'total_chars': len(report),
        'duplicates_removed': self.duplicates_removed
    }
    
    # 在报告开头插入数据源说明
    sources_section = self._generate_sources_section(sources_metadata)
    
    # 插入到报告中
    lines = report.split('\n')
    # 在标题后插入数据源说明
    lines.insert(2, sources_section)
    
    return '\n'.join(lines)

def _generate_sources_section(self, metadata: dict) -> str:
    """生成数据源说明章节"""
    sources_list = '\n'.join([
        f"{i}. ✅ **{source}**" 
        for i, source in enumerate(metadata['sources_used'], 1)
    ])
    
    return f"""
## 📊 数据来源说明

本报告基于以下**{metadata['sources_count']}个数据源**的综合分析：

{sources_list}

📏 **总数据量**: {metadata['total_chars']} 字符
🔄 **去重统计**: {metadata['duplicates_removed']} 条重复已移除

---
"""
```

---

## 预期效果

### 修复前
用户看到的报告：
```markdown
# 小米集团-W (01810.HK) 新闻与资金面深度分析报告

好的，作为一名专业的财经新闻分析师...
```
❌ 用户不知道数据来自哪里

### 修复后
用户看到的报告：
```markdown
# 小米集团-W (01810.HK) 新闻与资金面深度分析报告

## 📊 数据来源说明

本报告基于以下**5个数据源**的综合分析：

1. ✅ **东方财富** - 个股实时新闻
2. ✅ **Playwright爬虫** - 网页抓取
3. ✅ **多源快讯** - AKShare聚合
4. ✅ **Serper** - Google搜索
5. ✅ **yfinance** - Yahoo Finance（10条新闻）

📏 **总数据量**: 15,234 字符
🔄 **去重统计**: 3条重复已移除

---

## 一、核心新闻事件总结
...
```
✅ 用户清楚知道使用了哪些数据源

---

## 总结

**核心问题**: 用户看不到后台使用了哪些数据源

**推荐方案**: 在最终报告开头添加"数据来源说明"章节

**实施难度**: 低（只需修改Agent提示词和报告格式化逻辑）

**预期效果**: 用户能清楚看到yfinance等所有数据源的使用情况
