# TradingAgents-CN Docker Compose 配置
# 
# 适用于: 1G+ 内存 VPS / NAS / 本地服务器
# 
# 使用方法:
#   docker-compose up -d
#
# 内存分配 (已优化，1G VPS可用):
#   - MongoDB: 256MB (wiredTiger缓存200MB)
#   - Redis: 64MB (maxmemory 50MB + LRU淘汰)
#   - Streamlit: 450MB
#   - 总计约770MB，留200MB给系统

services:
  # ==========================================
  # MongoDB 数据库
  # ==========================================
  mongodb:
    # 使用 mongo:4.4 兼容无 AVX 指令集的 CPU（MongoDB 5.0+ 强制要求 AVX）
    image: mongo:4.4
    container_name: tradingagents-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=tradingagents123
      - TZ=Asia/Shanghai
    volumes:
      - mongodb_data:/data/db
    # 内存优化：限制wiredTiger缓存
    command: >
      mongod
      --wiredTigerCacheSizeGB 0.25
      --setParameter diagnosticDataCollectionEnabled=false
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      # mongo:4.4 使用 mongo shell 而非 mongosh
      test: echo 'db.runCommand("ping").ok' | mongo localhost:27017/test --quiet
      interval: 60s
      timeout: 10s
      retries: 3

  # ==========================================
  # Redis 缓存
  # ==========================================
  redis:
    image: redis:7-alpine
    container_name: tradingagents-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    # 内存优化：限制maxmemory + LRU淘汰
    command: >
      redis-server
      --requirepass tradingagents123
      --maxmemory 50mb
      --maxmemory-policy allkeys-lru
      --save ""
      --appendonly no
    environment:
      - TZ=Asia/Shanghai
    volumes:
      - redis_data:/data
    deploy:
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 32M
    healthcheck:
      test: [ "CMD", "redis-cli", "-a", "tradingagents123", "ping" ]
      interval: 60s
      timeout: 10s
      retries: 3

  # ==========================================
  # TradingAgents 主应用
  # ==========================================
  tradingagents:
    image: ghcr.io/1williamaoayers/tradingagents-arm32:dev
    container_name: tradingagents
    restart: unless-stopped
    user: root
    ports:
      - "8000:8000"  # FastAPI backend
      - "8501:8501"  # Streamlit frontend
    volumes:
      - .:/app
      - data:/app/data
      - logs:/app/logs
      - cache:/app/cache
    env_file:
      - .env
    environment:
      - TZ=Asia/Shanghai
      - MONGODB_HOST=mongodb
      - MONGODB_PORT=27017
      - MONGODB_USERNAME=admin
      - MONGODB_PASSWORD=tradingagents123
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=tradingagents123
      # Python内存优化
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - MALLOC_ARENA_MAX=2
    command: /bin/bash /app/run_all.sh
    deploy:
      resources:
        limits:
          memory: 450M
        reservations:
          memory: 256M
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      test: [ "CMD", "curl", "-f", "http://localhost:8501/_stcore/health" ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ==========================================
  # PlaywriteOCR 爬虫服务 (新增集成)
  # ==========================================
  playwriteocr:
    image: ghcr.io/1williamaoayers/playwriteocr:latest
    container_name: playwriteocr
    restart: unless-stopped
    ports:
      - "9527:9527"
    deploy:
      resources:
        limits:
          memory: 512M  # 爬虫比较吃内存，浏览器进程
        reservations:
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9527/api/v1/health"]
      interval: 60s
      timeout: 10s
      retries: 3

volumes:
  mongodb_data:
  redis_data:
  data:
  logs:
  cache:
