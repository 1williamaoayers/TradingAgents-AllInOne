# 🐛 问题追踪记录 (Issue Tracker)

本文档用于集中记录项目中发现的 Bug、缺陷及待修复问题。

## 🔴 [High] 首次部署港股名称无法显示

- **发现日期**: 2026-01-25
- **状态**: 确认存在的 Bug (Confirmed)
- **发现人**: Playwright 自动化验证 (Headless Check)
- **环境**: Windows 11, Docker Desktop, Fresh Install (冷启动)

### 1. 问题描述
在全新部署的环境中（已有数据清空），添加港股代码（如 `01810` 小米集团）后，自选股列表仅显示股票代码，**无法显示股票中文名称**。
即使手动点击“基础数据管理”中的“🔄 同步股票名称”按钮并提示成功，页面刷新后名称依然未显示。

### 2. 复现步骤 (Reproduction)
1. 执行 `docker-compose down -v` 清空所有数据。
2. 执行 `docker-compose up -d` 启动服务。
3. 登录 Web 界面 (`admin`/`admin123`)。
4. 进入“自选股管理”页面。
5. 切换市场为“港股”，输入代码 `01810`，点击添加。
6. **现象**: 列表显示 `港股 (1只) 01810 📅`，名称部分为空白或未渲染。

### 3. 证据 (Evidence)
- **Playwright 截图**:
  - 添加后截图: `page-2026-01-25T01-40-02-222Z.png` (显示 `01810` 无名称)
  - 同步后截图: `page-2026-01-25T01-40-36-562Z.png` (提示同步完成)
  - 刷新后截图: `page-2026-01-25T01-40-58-817Z.png` (依然无名称)

### 4. 疑似原因 (Root Cause Analysis)
- **数据源问题**: AkShare 接口可能在 Docker 容器内部访问受限，或者返回的数据结构发生变化导致解析失败。
- **缓存机制**: `st.cache_data` 可能未正确更新，或者 MongoDB 中的 `stock_names` 集合写入失败。
- **前端渲染**: Streamlit 的 `AgGrid` 或 `DataTable` 可能在名称字段为空时未正确 fallback。

### 5. 临时规避 (Workaround)
- 暂无有效规避方案。需等待后台定时任务 (Cron) 自动重试或修复代码。

---

## 🔴 [High] Agent 执行 PowerShell Web 请求卡死

- **发现日期**: 2026-01-25
- **状态**: 已确诊 (Diagnosed)
- **原因**: Windows PowerShell `Invoke-WebRequest` 兼容性问题
- **环境**: Windows 11, Agent CLI

### 1. 问题描述
Agent 在执行"服务启动检查"时，尝试使用 `Invoke-WebRequest http://localhost:8501` 来验证端口。
该命令在部分 Windows 环境下（受 IE 初始化配置或防火墙影响）极不稳定，会导致 PowerShell 进程挂起或抛出 `WebCmdletWebResponseException` 异常，最终导致 Agent 自身卡死。

### 2. 证据 (Evidence)
- **报错**: `Invoke-WebRequest : 无法连接到远程服务器...`
- **现象**: Agent 界面卡在 "Running Port Check..." 且无法恢复。

### 3. 规避方案 (Policy)
- **禁止使用**: 严禁 Agent 在 Windows 环境下直接调用 `Invoke-WebRequest` 进行连通性检查。
- **推荐替代**:
  - 使用 `netstat -an | findstr 8501` 检查端口监听。
  - 使用 Python `socket` 库进行 Check。
  - 或者直接相信 `docker ps` 的状态。

---

---

## 🔴 [High] Windows Docker 挂载失效导致配置不同步

- **发现日期**: 2026-01-25
- **状态**: 已确诊 (Diagnosed)
- **原因**: **Docker Volume Bind Mount Failure on Windows**
  - Windows宿主机上的 `.env` 文件修改无法实时同步到容器内。
  - 容器内应用（前端）修改配置写入 `/app/.env` 后，无法同步回宿主机。
  - 根本原因通常涉及 Windows 文件系统句柄锁定 (File Handle Locking) 或 Python 写文件时的 Inode 变更，导致 Docker 挂载链接断开。
- **环境**: Windows 11 + Docker Desktop (WSL2 backend)

### 1. 现象 (Symptoms)
- 前端网页显示配置已保存 (Green Check)。
- 后端 CLI 或容器重启后，配置依然是旧的 (例如 `USE_MONGODB_STORAGE` 仍为 false)。
- 宿主机 `.env` 文件与容器内 `/app/.env` 内容完全不一致。

### 2. 规避方案 (Policy)
- **弃用文件同步**: 不要在 Windows 环境下依赖 `.env` 文件的双向同步。
- **启用数据库存储**: 必须在 `.env` 中强制设置 `USE_MONGODB_STORAGE=true`。
  - 让应用直接读写 MongoDB，绕过文件系统挂载的不稳定性。
  - 这里的 `.env` 仅作为初始引导配置 (Bootstrap Config)。

---
