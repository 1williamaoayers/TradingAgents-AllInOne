---
description: 核心规则自检清单 - 快速验证是否遵守规则
trigger_keywords: ["违规", "反省", "检查规则"]
---

# 核心规则自检清单

## 使用场景
- 检测到可能违规时
- 用户说"违规"、"反省"、"检查规则"时
- 开工仪式检测到异常时

---

## 快速自检（每次回复前）

### 检查0：语言锁 🔴 最高优先级（无法脚本验证）
- [ ] 我的回复是**全中文**吗？ → 不是就立即重写
- [ ] **Task UI (TaskName/Status) 必须全中文** (严禁 "Fixing Bug" / "Update TODO.md" 等英文) → 立即翻译为中文 (e.g. "修复Bug" / "更新任务列表")
- [ ] 我在输出前问了自己"这是中文吗？" → 必须养成习惯
- [ ] 有没有整段英文？ → **严禁**，只允许代码变量名/API名用英文

**⚠️ 此规则无法用脚本自动验证，必须人工自检！**

### 检查0.5：验证方式限制 🔴 高优先级
- [ ] 我是否在用**脚本**验证项目代码/功能？ → **严禁**，必须人工验证
- [ ] 我是否用 `python verify_xxx.py` 这类脚本验证？ → **禁止**
- [ ] 正确做法：直接运行项目代码、查看日志、检查输出

**⚠️ 项目验证必须使用真实运行结果，禁止写脚本自动验证！**

### 检查0.6：测试脚本禁令 🔴 绝对禁止
- [ ] 我是否创建了任何测试脚本（test_*.py, verify_*.py等）？ → **绝对禁止**
- [ ] 我是否建议用户创建测试脚本？ → **绝对禁止**
- [ ] 我是否使用了现有的测试脚本？ → **绝对禁止**
- [ ] 正确做法：直接运行项目本身，查看实际运行结果

**⚠️ 任何形式的测试脚本都是违规行为！必须使用项目真实运行验证！**

### 检查1：触发词检测
- [ ] 用户说了"开始"/"继续"但我没执行 /start 吗？
- [ ] 用户说了"部署"但我没执行 /deploy 吗？
- [ ] 用户说了"验证"但我没执行 /test-verification 吗？

**如果任何一项是 ✓ → 违规！立即执行对应工作流**

### 检查2：证据检查
- [ ] 我说了"已读取"但回复中没有引用内容吗？
- [ ] 我说了"已验证"但没有展示测试输出吗？
- [ ] 我说了"完成"但没有测试证据吗？

### 检查2.5：主动执行禁令 🔴 高优先级
- [ ] 我是否让用户"手动执行"某个命令？ → **违规**，应该自己执行
- [ ] 我是否让用户"自己查看"某个页面？ → **违规**，应该自己查看
- [ ] 我是否让用户"手动验证"某个结果？ → **违规**，应该自己验证
- [ ] 我是否说"你可以去XXX查看"？ → **违规**，应该自己去查看

**核心原则**：
- ❌ 禁止：让用户手动执行、手动查看、手动验证
- ✅ 必须：自己执行、自己查看、自己验证

**正确做法**：
1. 需要执行命令 → 自己用executePwsh执行
2. 需要查看网页 → 自己用webFetch获取
3. 需要验证结果 → 自己运行并检查输出
4. 无法自动完成 → 明确说明原因，提供替代方案

**违规示例**：
- "你现在可以去GitHub Actions页面查看" → 应该：自己用webFetch获取页面
- "请手动执行docker pull命令" → 应该：自己执行docker pull
- "你可以运行这个命令验证" → 应该：自己运行命令并展示结果

**例外情况**（仅限以下场景可以让用户手动操作）：
1. 需要用户输入密码/API密钥等敏感信息
2. 需要用户在浏览器中登录认证
3. 操作会修改生产环境数据需要用户确认
4. 工具权限不足无法执行（如需要sudo）

**可用工具提醒** 🛠️：
在执行任务前，记住你有以下强大工具可用：
1. **GitHub CLI** (`gh`命令) - 查看Actions状态、PR、Issues等
   - 示例：`gh run list`, `gh run view`, `gh pr list`
2. **MCP Playwright** (浏览器自动化) - 访问需要登录的网页、截图、交互
   - 可以打开GitHub网页、点击按钮、获取页面内容
3. **Docker Desktop** - 管理容器、查看日志、重启服务
   - 所有docker命令都可以直接执行

**优先使用这些工具而不是让用户手动操作！**

**禁止要求用户手动执行的操作** 🚫：
以下操作必须由Agent自己执行，严禁要求用户手动操作：
- ❌ "你现在可以去GitHub Actions页面查看" → 应该用 `gh run list` 或 MCP Playwright
- ❌ "请手动执行docker pull" → 应该用 `docker pull` 命令
- ❌ "你可以运行这个命令验证" → 应该自己运行并展示结果
- ❌ "请访问XXX网页查看" → 应该用 `webFetch` 或 MCP Playwright
- ❌ "请手动重启容器" → 应该用 `docker restart` 命令

**如果任何一项是 ✓ → 违规！必须补充证据**

### 检查3：推测检查
- [ ] 我的回复包含"应该"、"可能"、"大概"吗？
  - ✅ 有 → 检查是否有对应的证据（文件路径+行号）
  - ❌ 没有证据 → 违规！必须补充证据或修改表述

### 检查3.5：未经验证推理禁令 🔴 高优先级
- [ ] 我是否说了"可能有bug"但没有实际调试验证？ → **违规**
- [ ] 我是否说了"可能是XXX原因"但没有查看日志/代码证据？ → **违规**
- [ ] 我是否说了"应该是XXX导致的"但没有实际测试？ → **违规**
- [ ] 我是否在没有完全验证的情况下就报告任务完成？ → **违规**

**核心原则**：
- ❌ 禁止：推测原因、猜测结果、假设完成
- ✅ 必须：实际验证、查看证据、确认完成

**正确做法**：
1. 发现问题 → 添加调试日志 → 重新运行 → 查看实际输出
2. 怀疑原因 → 查看相关代码 → 检查日志证据 → 得出结论
3. 任务接近完成 → 全面验证所有要求 → 确认无遗漏 → 才能报告完成

**违规示例**：
- "yfinance可能有bug" → 应该：添加调试日志，重新运行，查看实际执行流程
- "可能是1810.HK没有yfinance新闻源" → 应该：手动测试API，查看返回数据
- "应该已经完成了" → 应该：逐项检查任务要求，确认每项都有证据

### 检查4：中途汇报检查
- [ ] 我用了 notify_user 吗？
  - ✅ 用了 → 任务100%完成了吗？
  - ❌ 没完成 → 违规！继续工作，不要中途汇报

### 检查5：文件读取检查
- [ ] 我一次并行读取超过2个文件了吗？
- [ ] 我读取超过300行的文件但没先用 view_file_outline 吗？

**如果任何一项是 ✓ → 违规！分批读取**

### 检查6：防崩溃规则 ⚠️ 高优先级
- [ ] 我的回复超过 500 字了吗？ → **保持简短，减少超时风险**
- [ ] 我一次并行调用超过 3 个工具了吗？ → **最多 2-3 个工具调用**
- [ ] 我每完成一个重要步骤后写入 notes.md 了吗？ → **定期存档，崩溃可恢复**
- [ ] 我执行 Docker 日志命令时加了 `--tail` 限制了吗？ → **敏感命令必须加保护**
- [ ] 我执行的命令可能产生大量输出吗？ → **必须限制输出行数**

**防崩溃核心原则**：
```
回复要短，工具要少
存档要勤，输出要限
宁可分步，不可贪多
```

**敏感命令保护示例**：
```bash
# ❌ 错误：可能输出大量日志导致崩溃
docker logs container_name

# ✅ 正确：限制输出行数
docker logs --tail 50 container_name
docker compose logs --tail 30 service_name
```

### 检查7：智能等待策略 ⏳ 防断线
根据任务时长应用不同策略：

| 任务类型 | 时长 | 策略 |
|:---|:---|:---|
| 短任务 | <3分钟 | 正常等待 → 获取结果 → 验证 |
| 长任务 | 3-15分钟 | 分段等待 + 进度检查 (每60秒轮询) |
| 超长任务 | >15分钟 | 分段等待 + 进度检查 (每2-3分钟轮询) |

**长任务熔断器**：
- [ ] 连续2次轮询无进度？ → **立即停止，报告问题**
- [ ] 运行超过180秒无输出？ → **先读取最后10行日志，分析原因后汇报**
- [ ] 操作变慢/延迟增加？ → **立即暂停，输出进度让用户确认**

**主动中断刷新**：
- 每 2-3 分钟主动停下来问："继续下一步？"
- 强制刷新会话，重置后端超时计时器

### 检查8：任务拆解规则 🔀 防卡死
**核心原则**：永远不要让单次执行超过 3 分钟！

预估任务超过3分钟时：
1. **立即停止**，先输出拆解方案
2. 格式："这个任务我会分 X 步完成，每步约 Y 分钟"
3. 等用户确认后再开始

**拆解示例**：
```
用户："分析所有 API 文件"
我："有15个文件，我分3批分析：
  批次1: 分析5个核心API (3分钟)
  批次2: 分析5个次要API (3分钟)
  批次3: 分析剩余5个 + 总结 (3分钟)
现在开始批次1？"
```

---

## 核心口诀

```
看了再说，不看不说
做完再报，没完不报
用证据说话，不用想象
用结果交付，不用承诺
要多少给多少，不打折扣
```

---

## 如果检测到违规

1. **立即停止**当前操作
2. **说明违规**：在回复中明确说明违规内容
3. **执行纠正**：
   - 如果是跳过工作流 → 立即执行对应工作流
   - 如果是缺少证据 → 补充证据
   - 如果是推测 → 查看实际文件并引用
4. **重新汇报**：按正确格式重新汇报

---

## 违规示例与纠正

### 示例1：跳过开工仪式
**违规**：用户说"继续"，我直接回复没执行/start
**纠正**：立即执行 `view_file .agent/workflows/start.md`

### 示例2：缺少证据
**违规**："我已读取.antigravityrules"（没有引用内容）
**纠正**："我已读取.antigravityrules L1-3: 语言强制锁、三层记忆系统..."

### 示例3：推测
**违规**："系统应该是这样设计的..."
**纠正**："根据 app/main.py L123-145: [引用代码]，系统设计是..."

### 示例3.5：未经验证的推理
**违规**："yfinance可能有bug，可能是1810.HK没有新闻源"
**纠正**："我添加调试日志到第1050-1065行，重新构建镜像运行后，日志显示..."

**违规**："应该已经完成了"
**纠正**："已验证：✅ yfinance代码已整合 ✅ 库已安装 ✅ 容器已运行 ✅ 分析已完成 ✅ 日志显示yfinance被调用"

### 示例4：中途汇报
**违规**：任务进行到一半就 notify_user
**纠正**：继续完成任务，全部完成后再汇报
