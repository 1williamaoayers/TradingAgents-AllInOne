# 防响应中断协议

## 触发条件
当我准备执行以下操作时，必须先读取此工作流：
- 读取 2+ 个文件
- 读取超过 300 行的文件
- 执行复杂的多步骤操作

---

## 核心原则
**控制单次操作的复杂度，避免响应被截断**

---

## 文件读取限制

### ❌ 禁止行为
- 一次并行读取超过 2 个文件
- 读取超过 300 行的文件不先用 `view_file_outline`
- 读取大文件不使用 StartLine/EndLine 分段

### ✅ 正确做法

#### 1. 大文件处理
```
步骤1: view_file_outline file.py
步骤2: view_code_item file.py L1-100
步骤3: view_code_item file.py L101-200
```

#### 2. 多文件处理
```
第一批: 读取 file1.py, file2.py
第二批: 读取 file3.py, file4.py
第三批: 读取 file5.py, file6.py
```

#### 3. 分段读取示例
```
任务：分析 500 行的 main.py

❌ 错误：view_file main.py (一次读 500 行)

✅ 正确：
1. view_file_outline main.py (查看结构)
2. view_code_item main.py L1-150 (读第一部分)
3. view_code_item main.py L151-300 (读第二部分)
4. view_code_item main.py L301-500 (读第三部分)
```

---

## 输出长度控制

### ❌ 禁止行为
- 在工具输出后写超过 500 字的分析
- 一次性完成"分析 + 修改 + 验证 + 推送"全流程

### ✅ 正确做法
- 工具调用后简短总结（< 200 字）
- 需要详细分析时分步进行
- 每步完成后给用户简短反馈

---

## 任务分解

### 复杂任务必须分解

#### ❌ 错误：一次完成
```
1. 分析 10 个文件
2. 修改代码
3. 运行测试
4. 提交推送
```
→ 可能导致响应截断

#### ✅ 正确：分步执行
```
第一步：分析 2 个核心文件 → 反馈
第二步：分析剩余文件 → 反馈
第三步：修改代码 → 反馈
第四步：运行测试 → 反馈
第五步：提交推送 → 反馈
```

---

## 自检清单

在执行前问自己：

- [ ] 我准备读取几个文件？
  - > 2 个需分批

- [ ] 文件有多大？
  - > 300 行需分段

- [ ] 我准备写多少字分析？
  - > 500 字需分步

- [ ] 这个任务有几个步骤？
  - > 3 步需分解

**如果任何一项超标，必须分解！**

---

## 示例对比

### ❌ 错误示范
```
我：现在分析所有 API 文件...
[读取 10 个文件]
[写 1000 字分析]
[响应被截断]
```

### ✅ 正确示范
```
我：这个项目有 10 个 API 文件，我分 3 批分析

第一批：分析 api/auth.ts, api/user.ts
[读取 2 个文件]
[简短总结 100 字]

继续第二批？
```

---

## 紧急情况处理

### 如果发现响应变慢
1. 立即停止当前操作
2. 输出："为防中断，暂停在此。已完成 X，回复'继续'执行下一步"
3. 将当前进度写入 `notes.md`
4. 等待用户确认

### 如果响应被截断
1. 用户会看到不完整的输出
2. 下次对话从 `notes.md` 恢复进度
3. 调整策略，进一步分解任务
