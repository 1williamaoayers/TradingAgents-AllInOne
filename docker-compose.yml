version: '3.8'

services:
  # ==========================================
  # MongoDB æ•°æ®åº“ (å…¼å®¹æ— AVX CPU)
  # ==========================================
  mongodb:
    image: mongo:4.4
    container_name: ta-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=tradingagents123
      - TZ=Asia/Shanghai
    volumes:
      - mongodb_data:/data/db
    command: >
      mongod --wiredTigerCacheSizeGB 0.25 --setParameter diagnosticDataCollectionEnabled=false
    deploy:
      resources:
        limits:
          memory: 512M
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongo localhost:27017/test --quiet
      interval: 60s
      timeout: 10s
      retries: 3

  # ==========================================
  # Redis ç¼“å­˜
  # ==========================================
  redis:
    image: redis:7-alpine
    container_name: ta-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: >
      redis-server --requirepass tradingagents123 --maxmemory 50mb --maxmemory-policy allkeys-lru
    deploy:
      resources:
        limits:
          memory: 128M
    healthcheck:
      test: [ "CMD", "redis-cli", "-a", "tradingagents123", "ping" ]
      interval: 60s
      timeout: 10s
      retries: 3

  # ==========================================
  # PlaywriteOCR çˆ¬è™«æœåŠ¡ (ç‹¬ç«‹è¿è¡Œ)
  # ==========================================
  playwriteocr:
    image: ghcr.io/1williamaoayers/playwriteocr:latest
    container_name: ta-scraper
    restart: unless-stopped
    ports:
      - "9527:9527"
    deploy:
      resources:
        limits:
          memory: 1G # çˆ¬è™«éœ€è¦è¾ƒå¤šå†…å­˜
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9527/api/v1/health" ]
      interval: 60s
      timeout: 10s
      retries: 3

  # ==========================================
  # TradingAgents ä¸»åº”ç”¨
  # ==========================================
  tradingagents:
    image: ghcr.io/1williamaoayers/tradingagents-allinone:dev
    # build:
    #   context: ./src
    #   dockerfile: Dockerfile
    container_name: ta-app
    restart: unless-stopped
    ports:
      # - "8000:8000" # é¿å…ç«¯å£å†²çªï¼Œä»…æš´éœ² Web UI
      - "8501:8501"
    volumes:
      - ta_data:/app/data
      - ta_logs:/app/logs
      - ./.env:/app/.env
      # ğŸ”¥ [æ ¸å¿ƒä¼˜åŒ–] æŒ‚è½½æºç åˆ°å®¹å™¨ï¼Œå®ç°çƒ­æ›´æ–°
      # è¿™æ ·ä¿®æ”¹ä»£ç åé‡å¯å®¹å™¨å³å¯ç”Ÿæ•ˆï¼Œæ— éœ€é‡æ–°æ„å»ºé•œåƒ
      - ./src:/app
    env_file:
      - .env
    environment:
      - TZ=Asia/Shanghai
      - MONGODB_HOST=mongodb
      - MONGODB_PORT=27017
      - MONGODB_USERNAME=admin
      - MONGODB_PASSWORD=tradingagents123
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=tradingagents123
      # è‡ªåŠ¨è¿æ¥å†…éƒ¨çˆ¬è™«æœåŠ¡
      - SCRAPER_API_URL=http://playwriteocr:9527
    deploy:
      resources:
        limits:
          memory: 1G
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      playwriteocr:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8501/_stcore/health" ]
      interval: 60s
      timeout: 10s
      retries: 3

volumes:
  mongodb_data:
  redis_data:
  ta_data:
  ta_logs:
