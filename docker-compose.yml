version: '3.8'

services:
  # ==========================================
  # MongoDB 数据库 (兼容无AVX CPU)
  # ==========================================
  mongodb:
    image: mongo:4.4
    container_name: ta-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=tradingagents123
      - TZ=Asia/Shanghai
    volumes:
      - mongodb_data:/data/db
    command: >
      mongod --wiredTigerCacheSizeGB 0.25 --setParameter diagnosticDataCollectionEnabled=false
    deploy:
      resources:
        limits:
          memory: 512M
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongo localhost:27017/test --quiet
      interval: 60s
      timeout: 10s
      retries: 3

  # ==========================================
  # Redis 缓存
  # ==========================================
  redis:
    image: redis:7-alpine
    container_name: ta-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: >
      redis-server --requirepass tradingagents123 --maxmemory 50mb --maxmemory-policy allkeys-lru
    deploy:
      resources:
        limits:
          memory: 128M
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "tradingagents123", "ping"]
      interval: 60s
      timeout: 10s
      retries: 3

  # ==========================================
  # PlaywriteOCR 爬虫服务
  # ==========================================
  playwriteocr:
    image: ghcr.io/1williamaoayers/playwriteocr:latest
    container_name: ta-scraper
    restart: unless-stopped
    ports:
      - "9527:9527"
    deploy:
      resources:
        limits:
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9527/api/v1/health"]
      interval: 60s
      timeout: 10s
      retries: 3

  # ==========================================
  # RSSHub 自建RSS服务
  # ==========================================
  rsshub:
    image: diygod/rsshub:latest
    container_name: ta-rsshub
    restart: unless-stopped
    ports:
      - "1200:1200"
    environment:
      - TZ=Asia/Shanghai
      - NODE_ENV=production
      - CACHE_TYPE=redis
      - REDIS_URL=redis://:tradingagents123@redis:6379/
      - PUPPETEER_WS_ENDPOINT=  # 禁用Puppeteer节省内存
    deploy:
      resources:
        limits:
          memory: 256M
    depends_on:
      - redis
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:1200/"]
      interval: 60s
      timeout: 10s
      retries: 3

  # ==========================================
  # TradingAgents 主应用
  # ==========================================
  tradingagents:
    image: ghcr.io/1williamaoayers/tradingagents-allinone:dev
    container_name: ta-app
    restart: unless-stopped
    ports:
      - "8501:8501"
    volumes:
      - ta_data:/app/data
      - ta_logs:/app/logs
      - ./.env:/app/.env:rw  # 必须是rw，否则Web界面无法保存配置
    env_file:
      - .env
    environment:
      - TZ=Asia/Shanghai
      # 数据库连接
      - MONGODB_HOST=mongodb
      - MONGODB_PORT=27017
      - MONGODB_USERNAME=admin
      - MONGODB_PASSWORD=tradingagents123
      - MONGODB_CONNECTION_STRING=mongodb://admin:tradingagents123@mongodb:27017/tradingagents?authSource=admin
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=tradingagents123
      # 爬虫服务
      - SCRAPER_API_URL=http://playwriteocr:9527
      # RSSHub服务
      - RSSHUB_URL=http://rsshub:1200
    deploy:
      resources:
        limits:
          memory: 1G
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      playwriteocr:
        condition: service_healthy
      rsshub:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 60s
      timeout: 10s
      retries: 3

volumes:
  mongodb_data:
  ta_data:
  ta_logs:
