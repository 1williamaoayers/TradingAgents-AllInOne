trigger: always_on
alwaysApply: true
---
# 🧬 绝对指令 (v5.1 Kernel)

## 0. 语言锁 (LANGUAGE LOCK)
- **所有产出必须是中文**。
- 每次输出前说：“这是中文吗？”

## 1. 启动协议 (START PROTOCOL)
- **触发**: 新对话 / "开始" / "继续"
- **执行**: `view_file .agent/workflows/start.md`
- **严禁**: 跳过开工仪式直接干活。

## 2. 双核记忆锁 (DUAL MEMORY LOCK)
- **TODO.md** (User View): 秒级同步。
- **notes.md** (Agent View): 记录过程。


### 6. 🛡️ 工具安全协议 (TOOL SAFETY)
- **禁止终端写入**: 严禁使用 `run_command` 执行 `Add-Content`, `echo`, `printf` 等写入文件的操作。
- **强制原生工具**: 必须使用 `write_to_file` 或 `replace_file_content` 进行文件修改。
- **禁止 PowerShell Web请求**: 严禁使用 `Invoke-WebRequest` / `curl` (PowerShell alias) / `wget` 进行连通性检查。
- **推荐替代**: 使用 `netstat` 或 Python `socket` (如 `src/scripts/check_port.py`)。
- **原因**: 终端写入会触发安全弹窗；Web请求受限于 Win 兼容性。违者必究。

### 7. ⏳ 防卡死协议 (ANTI-FREEZE)
**核心原则**: 放弃主观预测，强制执行**分批标准 (Batch Standards)**。
1.  **阅读限制**: 单次工具调用不得超过 **3个文件** 或 **800行**。
2.  **写入限制**: 单次修改仅限 **1个核心逻辑块**。
3.  **运行监控 (Active Monitor)**:
    *   高危命令必须后台运行 (`WaitMs < 3000`).
    *   **严禁盲目等待**: 必须每 5-10 秒通过 `command_status` 轮询。
    *   **防僵死 (Anti-Zombie)**: 若 Status=RUNNING 且 >180s 无输出，**必须先读取最后10行日志分析原因**。
4.  **搜索限制**: 禁止全盘搜索，必须指定具体 `Directory` 或 `file pattern`。
5.  **回复简短**: 单次回复不超过 **500字**，减少超时风险。
6.  **工具调用限制**: 一次并行调用最多 **2-3个工具**，不可贪多。
7.  **定期存档**: 每完成重要步骤，立即写入 `notes.md`，崩溃可恢复。
8.  **敏感命令保护**: Docker日志必须加 `--tail 50` 限制输出。
**违规处置**: 只要操作超出上述标准，**必须**先执行 `long-task.md` 进行拆解。
- **铁律**: 先改 TODO，再动手 (Update First, Then Act)。

## 3. 验证锁 (VERIFICATION LOCK)
- **禁止**将来时 / 无证据打勾。
- **必须**拿到 Log/Screenshot。
- **禁止测试脚本锁 (NO TEST SCRIPT LOCK)**: 严禁创建临时测试脚本 (verify_*.py) 作为交付物或验证条件。验证必须基于真实环境 (Docker/App) 的直接指征。

## 4. 存档协议 (END PROTOCOL)
- **触发**: "暂停" / "下班" / "存档"
- **执行**: `view_file .agent/workflows/session-handover.md`

## 5. 工具箱导航 (WORKFLOW ROUTING)
遇到复杂任务，**优先**执行对应工作流：
- **提交/发布** → `.agent/workflows/deploy.md` (用户指令: "提交")
- **测试/验证** → `.agent/workflows/test-verification.md`
- **重置/纠错** → `.agent/workflows/reset.md`
- **违规/反省** → `.agent/workflows/rule.md`
- **记录/知识** → `.agent/workflows/memory-system.md` (用户指令: "记录")
- **收工/存档** → `.agent/workflows/session-handover.md` (用户指令: "收工")
